<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>GLACIER - Secure Web Viwer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      font-weight: 300;
      background: #ffffff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .browser-chrome {
      background: #ffffff;
      padding: 12px 30px;
      display: flex;
      gap: 20px;
      align-items: center;
      border-bottom: 1px solid #e8f4f8;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    /* ▼▼▼ CSS修正箇所 ▼▼▼ */
    .browser-chrome .logo {
      font-weight: 200 !important;
      font-size: 20px !important;
      color: #4fc3f7 !important;
      letter-spacing: 2px !important;
      margin-right: 20px !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif !important;
    }
    /* ▲▲▲ CSS修正箇所 ▲▲▲ */

    .url-bar {
      flex: 1;
      display: flex;
      gap: 10px;
    }

    /* ▼▼▼ CSS修正箇所 ▼▼▼ */
    .browser-chrome #urlInput {
      flex: 1;
      padding: 10px 20px !important;
      border: 1px solid #e0e0e0 !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      font-weight: 300 !important;
      outline: none !important;
      background: #fafafa !important;
      transition: all 0.3s ease !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif !important;
    }

    .browser-chrome #urlInput:focus {
      border-color: #4fc3f7 !important;
      background: #ffffff !important;
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1) !important;
    }

    .browser-chrome button {
      padding: 10px 28px !important;
      background: #4fc3f7 !important;
      color: white !important;
      border: none !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      font-size: 14px !important;
      font-weight: 300 !important;
      transition: all 0.3s ease !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif !important;
    }

    .browser-chrome button:hover {
      background: #29b6f6 !important;
    }

    .browser-chrome button:disabled {
      background: #e0e0e0 !important;
      cursor: not-allowed !important;
      color: #9e9e9e !important;
    }
    /* ▲▲▲ CSS修正箇所 ▲▲▲ */

    .nav-buttons {
      display: flex;
      gap: 8px;
    }

    /* ▼▼▼ CSS修正箇所 ▼▼▼ */
    .browser-chrome .nav-btn {
      width: 38px !important;
      height: 38px !important;
      padding: 0 !important;
      border-radius: 8px !important;
      background: #f5f5f5 !important;
      color: #757575 !important;
      font-weight: 300 !important;
      font-size: 18px !important;
      transition: all 0.2s ease !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif !important;
    }

    .browser-chrome .nav-btn:hover:not(:disabled) {
      background: #e3f2fd !important;
      color: #4fc3f7 !important;
    }

    .browser-chrome .nav-btn:disabled {
      background: #fafafa !important;
      color: #e0e0e0 !important;
    }
    /* ▲▲▲ CSS修正箇所 ▲▲▲ */

    .status {
      padding: 16px 30px;
      background: #fff9c4;
      font-size: 14px;
      font-weight: 300;
      display: none;
      animation: slideDown 0.3s ease;
      border-bottom: 1px solid #fff59d;
      position: fixed;
      top: 62px;
      left: 0;
      right: 0;
      z-index: 999;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status.show {
      display: block;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border-bottom: 1px solid #ef9a9a;
    }

    .status.success {
      background: #e0f7fa;
      color: #00796b;
      border-bottom: 1px solid #b2ebf2;
    }

    /* ▼▼▼ CSS修正箇所：高さを完全に占めるために flex を追加 ▼▼▼ */
    #content {
      flex: 1;
      background: white;
      overflow: auto;
      margin-top: 62px;
      
      /* position:fixed 重なり防止のための設定 */
      transform: translateZ(0);

      display: flex; /* flex コンテナ化 */
      flex-direction: column;
    }
    /* ▲▲▲ CSS修正箇所 ▲▲▲ */

    .loading {
      text-align: center;
      padding: 40px;
      color: #9e9e9e;
      font-weight: 300;
    }

    .spinner {
      border: 2px solid #f5f5f5;
      border-top: 2px solid #4fc3f7;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ▼▼▼ CSS修正箇所：背景設定と高さを完全に占めるための flex: 1 を追加 ▼▼▼ */
    .welcome-screen {
      text-align: center;
      padding: 120px 20px;
      background-image: url('wallpaper.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      flex: 1; /* 親要素 #content の残りのスペースを全て占める */
    }
    /* ▲▲▲ CSS修正箇所 ▲▲▲ */

    .welcome-screen h2 {
      font-size: 72px;
      font-weight: 100;
      color: #4fc3f7;
      margin-bottom: 60px;
      letter-spacing: 8px;
    }

    .welcome-search {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      padding: 0 20px;
    }

    .welcome-search input {
      flex: 1;
      padding: 16px 28px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 300;
      outline: none;
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .welcome-search input:focus {
      border-color: #4fc3f7;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
    }

    .welcome-search button {
      padding: 16px 40px;
      background: #4fc3f7;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 300;
      transition: all 0.3s ease;
    }

    .welcome-search button:hover {
      background: #29b6f6;
    }
  </style>
</head>
<body>
  <div class="browser-chrome">
    <div class="logo">GLACIER</div>
    <div class="nav-buttons">
      <button class="nav-btn" id="homeBtn" title="ホーム">⌂</button>
      <button class="nav-btn" id="backBtn" disabled title="戻る">←</button>
      <button class="nav-btn" id="forwardBtn" disabled title="進む">→</button>
      <button class="nav-btn" id="reloadBtn" disabled title="再読み込み">↻</button>
    </div>
    <div class="url-bar">
      <input type="text" id="urlInput" placeholder="Enter URL">
      <button id="goBtn">Go</button>
    </div>
  </div>

  <div class="status" id="status"></div>

  <div id="content">
    <div class="welcome-screen">
      <h2>GLACIER</h2>
      <div class="welcome-search">
        <input type="text" id="welcomeUrlInput" placeholder="Enter URL">
        <button id="welcomeGoBtn">Go</button>
      </div>
    </div>
  </div>

  <script>
    const urlInput = document.getElementById('urlInput');
    const goBtn = document.getElementById('goBtn');
    const homeBtn = document.getElementById('homeBtn');
    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const contentDiv = document.getElementById('content');
    const statusDiv = document.getElementById('status');
    const welcomeUrlInput = document.getElementById('welcomeUrlInput');
    const welcomeGoBtn = document.getElementById('welcomeGoBtn');

    let history = [];
    let historyIndex = -1;
    let currentUrl = '';

    // クライアント側でURLを短縮(Base64エンコード)
    function shortenUrl(url) {
      try {
        return btoa(unescape(encodeURIComponent(url)));
      } catch (e) {
        console.error('Encoding error:', e);
        return btoa(url);
      }
    }

    // ステータスメッセージ表示
    function showStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = `status show ${type}`;
      setTimeout(() => {
        statusDiv.className = 'status';
      }, 3000);
    }

    // ナビゲーションボタンの更新
    function updateNavButtons() {
      backBtn.disabled = historyIndex <= 0;
      forwardBtn.disabled = historyIndex >= history.length - 1;
      reloadBtn.disabled = !currentUrl;
    }

    // URLの読み込み
    async function loadUrl(url, addToHistory = true) {
      if (!url) return;

      // URLの正規化
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      try {
        goBtn.disabled = true;
        contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
        
        // クライアント側でURL短縮(Base64エンコード)
        const shortUrl = shortenUrl(url);
        
        showStatus('Secure connection loading...', 'info');
        console.log('Sending encoded URL:', shortUrl);

        // 短縮URLでHTML取得(元のURLは送信しない)
        const fetchRes = await fetch(`/fetch?h=${encodeURIComponent(shortUrl)}`);
        
        console.log('Response status:', fetchRes.status);
        
        const data = await fetchRes.json();
        console.log('Response data:', data);

        if (!fetchRes.ok) {
          throw new Error(data.error || 'Failed to fetch');
        }

        // HTMLを表示
        currentUrl = data.url;
        urlInput.value = currentUrl;
        displayHtml(data.html, currentUrl);

        // 履歴に追加
        if (addToHistory) {
          historyIndex++;
          history = history.slice(0, historyIndex);
          history.push(currentUrl);
        }

        updateNavButtons();
        showStatus('Loading complete', 'success');

      } catch (error) {
        console.error('Error:', error);
        contentDiv.innerHTML = `
          <div style="padding: 80px 40px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">⚠</div>
            <h2 style="color: #c62828; font-size: 32px; font-weight: 200; margin-bottom: 15px;">Connection Error</h2>
            <p style="color: #9e9e9e; font-size: 16px; font-weight: 300;">${error.message}</p>
          </div>
        `;
        showStatus('Error occurred', 'error');
      } finally {
        goBtn.disabled = false;
      }
    }

    // HTMLの表示とリンク・リソースの処理
    function displayHtml(html, baseUrl) {
      contentDiv.innerHTML = html;

      // URL解決のヘルパー関数
      function resolveUrl(relativeUrl, baseUrl) {
        // http, https, data:, mailto: などはそのまま返す
        if (!relativeUrl || relativeUrl.startsWith('http') || relativeUrl.startsWith('data:') || relativeUrl.startsWith('mailto:')) {
            return relativeUrl;
        }

        try {
            const base = new URL(baseUrl);
            
            if (relativeUrl.startsWith('//')) {
                // プロトコル相対URL (例: //example.com/style.css)
                return base.protocol + relativeUrl;
            } else if (relativeUrl.startsWith('/')) {
                // ドメイン絶対パス (例: /style.css)
                return base.origin + relativeUrl;
            } else {
                // 相対パス (例: style.css)
                // パス解決のため、pathnameの最後の要素(ファイル名)を除外
                const pathSegments = base.pathname.split('/').slice(0, -1);
                return base.origin + pathSegments.join('/') + '/' + relativeUrl;
            }
        } catch (e) {
            console.error("URL resolution error:", e);
            return relativeUrl;
        }
      }

      // CSSリンクのhrefを絶対パスに変換
      const cssLinks = contentDiv.querySelectorAll('link[rel="stylesheet"], link[rel="preload"][as="style"]');
      cssLinks.forEach(link => {
        const href = link.getAttribute('href');
        link.href = resolveUrl(href, baseUrl);
      });


      // すべてのリンクにクリックイベントを追加
      const anchorTags = contentDiv.querySelectorAll('a[href]');
      anchorTags.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          let href = link.getAttribute('href');

          if (href.startsWith('#')) {
             return; // アンカーリンクは無視
          }

          loadUrl(resolveUrl(href, baseUrl)); // resolveUrlで絶対パス化してロード
        });
      });

      // 画像のsrcを修正
      const images = contentDiv.querySelectorAll('img[src]');
      images.forEach(img => {
        let src = img.getAttribute('src');
        img.src = resolveUrl(src, baseUrl);
      });
    }

    // イベントリスナー
    goBtn.addEventListener('click', () => loadUrl(urlInput.value));
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadUrl(urlInput.value);
    });

    welcomeGoBtn.addEventListener('click', () => loadUrl(welcomeUrlInput.value));
    welcomeUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadUrl(welcomeUrlInput.value);
    });

    homeBtn.addEventListener('click', () => {
      currentUrl = '';
      urlInput.value = '';
      historyIndex = -1;
      history = [];
      // ホーム画面のHTML構造は変更なし
      contentDiv.innerHTML = `
        <div class="welcome-screen">
          <h2>GLACIER</h2>
          <div class="welcome-search">
            <input type="text" id="welcomeUrlInput" placeholder="Enter URL">
            <button id="welcomeGoBtn">Go</button>
          </div>
        </div>
      `;
      // ホーム画面の検索バーに再度イベントリスナーを設定
      const newWelcomeUrlInput = document.getElementById('welcomeUrlInput');
      const newWelcomeGoBtn = document.getElementById('welcomeGoBtn');
      newWelcomeGoBtn.addEventListener('click', () => loadUrl(newWelcomeUrlInput.value));
      newWelcomeUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadUrl(newWelcomeUrlInput.value);
      });
      updateNavButtons();
    });

    backBtn.addEventListener('click', () => {
      if (historyIndex > 0) {
        historyIndex--;
        loadUrl(history[historyIndex], false);
      }
    });

    forwardBtn.addEventListener('click', () => {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        loadUrl(history[historyIndex], false);
      }
    });

    reloadBtn.addEventListener('click', () => {
      if (currentUrl) loadUrl(currentUrl, false);
    });
  </script>
</body>
</html>